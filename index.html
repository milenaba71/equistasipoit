<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dolore + Dermatomeri (marker su colonna + dolore + muscolo)</title>
  <style>
    :root{--blue:#1f5eff;--bg:#f6f7fb;--card:#fff;--line:#d9dce6;--soft:#eef1ff;--text:#111;--muted:#555;}
    body{font-family:system-ui;margin:0;background:var(--bg);color:var(--text)}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    .card{background:var(--card);border-radius:16px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    h2{margin:0 0 6px}
    .small{font-size:12px;color:var(--muted);line-height:1.35}
    .pill{display:inline-block;background:var(--soft);color:var(--blue);padding:4px 10px;border-radius:999px;font-size:12px;margin-bottom:10px}
    .progress{height:10px;background:#e9ecf7;border-radius:999px;overflow:hidden;margin:12px 0 16px}
    .bar{height:100%;width:0%;background:var(--blue);transition:width .25s ease}
    .step{display:none}
    .step.active{display:block}

    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:980px){.row.two{grid-template-columns:1.05fr .95fr}}

    label{font-size:13px;color:#333;display:block;margin-bottom:6px}
    select,input,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;font-size:16px;background:#fff}
    textarea{min-height:90px;resize:vertical}

    .btnbar{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap}
    button{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-size:16px;cursor:pointer}
    button.primary{background:var(--blue);color:#fff}
    button.secondary{background:var(--soft);color:var(--blue)}
    button.ghost{background:transparent;color:var(--blue);border:1px solid #cfd6ff}

    .zones{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
    @media(min-width:980px){.zones{grid-template-columns:1fr 1fr}}
    .zoneBtn{width:100%;text-align:left;border:1px solid var(--line);background:#fff;border-radius:14px;padding:12px}
    .zoneBtn b{display:block;margin-bottom:6px}
    .zoneBtn small{color:#555}
    .zoneBtn.selected{border-color:var(--blue);box-shadow:0 0 0 3px rgba(31,94,255,.15)}

    .result{background:#f7f9ff;border:1px solid #dfe6ff;padding:12px;border-radius:12px;white-space:pre-wrap}
    .warn{background:#fff5f5;border:1px solid #ffd6d6;color:#7a1b1b;padding:12px;border-radius:12px;margin-top:12px}

    .mapBox{border:1px solid #e6e8f2;border-radius:16px;padding:12px;background:#fff}
    .mapGrid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:980px){.mapGrid{grid-template-columns:1fr 1fr}}
    .pane{border:1px solid #eef1ff;border-radius:16px;padding:10px;background:#fbfcff}
    .pane b{display:block;margin-bottom:6px}

    .imgWrap{position:relative;border-radius:14px;overflow:hidden;border:1px solid rgba(0,0,0,.06);background:#fff}
    .imgWrap img{width:100%;height:auto;display:block}
    .fallback{display:none;padding:10px;font-size:12px;color:#7a1b1b;background:#fff5f5;border-top:1px solid #ffd6d6}

    /* ✅ MARKER: bollino blu piccolo e cliccabile */
    .marker{
      position:absolute; transform:translate(-50%,-50%);
      display:none; z-index:50; pointer-events:auto;
      cursor:pointer; touch-action:manipulation; user-select:none;
    }
    .marker.show{display:block}
    .dot{
      width:9px;height:9px;border-radius:50%;
      background:var(--blue);
      border:2px solid #fff;
      box-shadow:0 0 0 3px rgba(31,94,255,.14);
    }
    .dot:hover{box-shadow:0 0 0 5px rgba(31,94,255,.18);}

    /* Modal */
    .modalBack{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:18px;z-index:99}
    .modal{max-width:900px;width:100%;background:#fff;border-radius:16px;padding:14px;box-shadow:0 20px 60px rgba(0,0,0,.25)}
    .modalHeader{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .closeBtn{background:transparent;border:1px solid #ddd;border-radius:10px;padding:6px 10px;font-size:14px;cursor:pointer}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
    .chip{background:var(--soft);color:var(--blue);padding:4px 10px;border-radius:999px;font-size:12px}
    .modalBody{font-size:14px;line-height:1.5;color:#222}
    .sec{border:1px solid #eef1ff;border-radius:14px;padding:12px;background:#fbfcff;margin-top:10px}
    .secTitle{font-weight:700;margin:0 0 6px}
    .patient{color:var(--blue);font-style:italic;background:#f7f9ff;border-color:#dfe6ff}
    .vertebraLine{margin-top:6px;padding:10px;border-radius:12px;border:1px solid #e6e8f2;background:#fff}
    .vertebraLine b{color:var(--blue)}
    code{background:#f1f3ff;padding:2px 6px;border-radius:8px}

    .hint{margin-top:10px;font-size:12px;color:#444}
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h2>Demo — 3 marker (colonna dermatomero + dolore + muscolo)</h2>
    <div class="small">
      Regola: il <b>marker 1</b> sulla colonna segue il <b>dermatomero</b> (colori/numero). Marker 2 = dolore. Marker 3 = muscolo.
    </div>

    <div class="progress"><div class="bar" id="bar"></div></div>

    <!-- STEP 1 -->
    <section class="step active" id="step1">
      <div class="pill">Passo 1/4</div>
      <p><b>Dove senti dolore?</b></p>

      <div class="row two">
        <div>
          <label>Area</label>
          <select id="area">
            <option value="">Seleziona…</option>
            <option value="mano">Mano / dita</option>
            <option value="ginocchio">Ginocchio</option>
          </select>
        </div>
        <div>
          <label>Lato</label>
          <select id="side">
            <option value="">Seleziona…</option>
            <option value="sinistro">Sinistro</option>
            <option value="destro">Destro</option>
            <option value="bilaterale">Bilaterale</option>
          </select>
        </div>
      </div>

      <div class="btnbar">
        <button class="primary" type="button" id="next1">Avanti</button>
      </div>
    </section>

    <!-- STEP 2 -->
    <section class="step" id="step2">
      <div class="pill">Passo 2/4</div>
      <p><b>Seleziona la zona</b></p>
      <div class="zones" id="zones"></div>

      <div class="btnbar">
        <button class="secondary" type="button" id="back2">Indietro</button>
        <button class="primary" type="button" id="next2">Avanti</button>
      </div>
    </section>

    <!-- STEP 3 -->
    <section class="step" id="step3">
      <div class="pill">Passo 3/4</div>
      <p><b>Dettagli</b></p>

      <div class="row two">
        <div>
          <label>Intensità (0–10)</label>
          <input id="intensity" type="number" min="0" max="10" step="1" placeholder="Es. 6">
        </div>
        <div>
          <label>Da quanto tempo?</label>
          <select id="duration">
            <option value="">Seleziona…</option>
            <option value="<24h">Meno di 24 ore</option>
            <option value="1-3g">1–3 giorni</option>
            <option value="4-14g">4–14 giorni</option>
            <option value=">2s">Oltre 2 settimane</option>
            <option value=">3m">Oltre 3 mesi</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Note (facoltativo)</label>
          <textarea id="notes" placeholder="Cosa lo peggiora/migliora?"></textarea>
        </div>
      </div>

      <div class="btnbar">
        <button class="secondary" type="button" id="back3">Indietro</button>
        <button class="primary" type="button" id="next3">Vedi marker</button>
      </div>
    </section>

    <!-- STEP 4 -->
    <section class="step" id="step4">
      <div class="pill">Passo 4/4</div>
      <p><b>Marker (3 punti)</b></p>

      <div class="row two">
        <div>
          <div class="result" id="summary"></div>
          <div class="warn" id="safety" style="display:none;"></div>

          <div class="btnbar">
            <button class="ghost" type="button" id="restart">Ricomincia</button>
            <button class="primary" type="button" id="copy">Copia testo</button>
          </div>

          <div class="hint">
            Se un marker non cade perfetto, devi solo regolare le coordinate <code>left/top</code> in <code>SPINE_LEVEL</code> o in <code>PATHWAYS</code>.
          </div>
        </div>

        <div class="mapBox">
          <div class="mapGrid">
            <div class="pane">
              <b>Colonna — segmenti (C…T…L…S)</b>
              <div class="imgWrap" id="wrapSpine">
                <img id="imgSpine" alt="Colonna segmenti">
                <div class="fallback" id="spineFallback">
                  <b>Immagine non trovata.</b><br>
                  Serve nel repo: <code>colonna_segmenti.png</code>
                </div>
              </div>
            </div>

            <div class="pane">
              <b>Dermatomeri sensitivi (colori + livelli)</b>
              <div class="imgWrap" id="wrapBody">
                <img id="imgBody" alt="Dermatomeri sensitivi">
                <div class="fallback" id="bodyFallback">
                  <b>Immagine non trovata.</b><br>
                  Serve nel repo: <code>dermatomeri-sensitivi.png</code>
                </div>
              </div>
              <div class="small">Qui compaiono Marker 2 (dolore) + Marker 3 (muscolo).</div>
            </div>
          </div>
        </div>

      </div>
    </section>

  </div>
</div>

<!-- MODAL -->
<div class="modalBack" id="modalBack">
  <div class="modal">
    <div class="modalHeader">
      <b id="modalTitle">Dettaglio</b>
      <button class="closeBtn" id="modalClose" type="button">Chiudi</button>
    </div>
    <div class="chips" id="modalChips"></div>

    <div class="modalBody">
      <div class="vertebraLine" id="modalVertebra"></div>

      <div class="sec">
        <div class="secTitle">Spiegazione scientifica / professionale</div>
        <div id="modalProfBody"></div>
      </div>

      <div class="sec patient">
        <div class="secTitle">Spiegazione per il paziente</div>
        <div id="modalPatientBody"></div>
      </div>
    </div>
  </div>
</div>

<script>
  /* ========== IMMAGINI (nel tuo repo) ========== */
  const IMG = {
    spineSegments: "./colonna_segmenti.png",
    bodyMap: "./dermatomeri-sensitivi.png"
  };

  /* ========== ZONE UI ========== */
  const ZONES = {
    mano: [
      ["pollice","Pollice","zona radiale mano"],
      ["indice","Indice","zona radiale mano"],
      ["medio","Dito medio","zona centrale mano"],
      ["anulare","Anulare","zona ulnare/centrale (variabile)"],
      ["mignolo","Mignolo","zona ulnare mano"]
    ],
    ginocchio: [
      ["mediale","Ginocchio interno (mediale)","lato interno ginocchio"],
      ["laterale","Ginocchio esterno (laterale)","lato esterno ginocchio"],
      ["anteriore","Ginocchio anteriore (rotula)","davanti"],
      ["posteriore","Ginocchio posteriore (cavo)","dietro"]
    ]
  };

  /* ========== COORDINATE SEGMENTI SULLA TUA colonna_segmenti.png ==========
     IMPORTANTE: questi TOP sono “base”. Se vuoi precisione perfetta sul TUO file,
     correggi i valori top di 1–3 punti finché il marker cade sulla scritta.
  ========== */
  const SPINE_LEVEL = {
    C2:{left:62, top:10}, C3:{left:62, top:13}, C4:{left:62, top:16}, C5:{left:62, top:19}, C6:{left:62, top:22}, C7:{left:62, top:25}, C8:{left:62, top:28},
    T1:{left:62, top:31}, T2:{left:62, top:34}, T3:{left:62, top:37}, T4:{left:62, top:40}, T5:{left:62, top:43}, T6:{left:62, top:46}, T7:{left:62, top:49},
    T8:{left:62, top:52}, T9:{left:62, top:55}, T10:{left:62, top:58}, T11:{left:62, top:61}, T12:{left:62, top:64},
    L1:{left:62, top:67}, L2:{left:62, top:70}, L3:{left:62, top:73}, L4:{left:62, top:76}, L5:{left:62, top:79},
    S1:{left:62, top:84}, S2:{left:62, top:87}, S3:{left:62, top:90}, S4:{left:62, top:93}, S5:{left:62, top:96}
  };

  /* ========== PERCORSI: per ogni zona definisci
     - dermatome (segmento colonna) -> marker 1
     - pain (coordinate su dermatomeri-sensitivi.png) -> marker 2
     - muscle (coordinate su dermatomeri-sensitivi.png) + muscleName -> marker 3
     - testi popup (scientifico + paziente)
  ========== */
  const PATHWAYS = {
    mano: {
      pollice: {
        dermatome: "C6",
        pain:   {left:26, top:56},
        muscle: {left:36, top:48},
        muscleName: "Comparto radiale avambraccio (estensori/abduttori del pollice)",
        scientific: `
          <p><b>Marker colonna (C6):</b> aggancio segmentario coerente col territorio radiale mano/pollice.
          L’obiettivo è modulare l’afferenza sensitiva/propriocettiva e ridurre il guadagno del sistema (iper-protezione).</p>
          <p><b>Marker dolore (pollice):</b> riduce il rumore nocicettivo locale e migliora la discriminazione sensoriale.</p>
          <p><b>Marker muscolo (pollice):</b> normalizza reclutamento e coordinazione fine (pinza/presa), riducendo co-contrazioni.</p>
        `,
        patient: `
          <p>Metti un bollino sul livello <b>C6</b> (colonna) perché “comanda” la zona del pollice.
          Poi un bollino dove fa male e uno sul muscolo dell’avambraccio che muove il pollice: così il movimento diventa più facile e meno rigido.</p>
        `
      },
      indice: {
        dermatome: "C6",
        pain:   {left:24, top:52},
        muscle: {left:36, top:46},
        muscleName: "Estensori dita (avambraccio dorsale)",
        scientific: `
          <p><b>C6:</b> riferimento segmentario per distretto radiale mano.</p>
          <p><b>Dolore:</b> miglioramento qualità del segnale locale.</p>
          <p><b>Muscolo:</b> ottimizzazione coordinazione estensione/presa.</p>
        `,
        patient:`<p>Bollino su <b>C6</b>, poi sul dolore e sul muscolo che muove il dito: aiuta a ridurre tensione e migliorare controllo.</p>`
      },
      medio: {
        dermatome: "C7",
        pain:   {left:22, top:49},
        muscle: {left:36, top:45},
        muscleName: "Estensore comune delle dita (Extensor digitorum)",
        scientific: `
          <p><b>Marker colonna (C7):</b> riferimento segmentario tipico per il distretto centrale della mano (dito medio).
          Lo stimolo favorisce integrazione sensitivo-motoria e riduce il “settaggio in allarme”.</p>
          <p><b>Marker dolore:</b> riduce ipersensibilità e migliora la precisione percettiva.</p>
          <p><b>Marker muscolo:</b> migliora sequenza di attivazione dell’estensore comune, riducendo co-contrazioni disfunzionali.</p>
        `,
        patient: `
          <p>Per il dito medio il livello guida è <b>C7</b>. Metti un bollino lì, uno dove senti dolore e uno sul muscolo che muove il dito:
          così la mano lavora più “morbida” e precisa.</p>
        `
      },
      anulare: {
        dermatome: "C8",
        pain:   {left:20, top:50},
        muscle: {left:38, top:46},
        muscleName: "Flessori/estensori dita (sinergia) – componente ulnare",
        scientific: `
          <p><b>C8:</b> (variabile, spesso C7–C8) qui usiamo C8 come riferimento ulnare.</p>
          <p><b>Dolore:</b> normalizza la sensibilità locale.</p>
          <p><b>Muscolo:</b> migliora sinergia presa/estensione.</p>
        `,
        patient:`<p>Bollino su <b>C8</b>, poi sul dolore dell’anulare e sul muscolo dell’avambraccio: aiuta a muovere meglio senza irrigidirti.</p>`
      },
      mignolo: {
        dermatome: "C8",
        pain:   {left:18, top:52},
        muscle: {left:40, top:48},
        muscleName: "Comparto ulnare mano/avambraccio (controllo mignolo)",
        scientific: `
          <p><b>C8:</b> riferimento segmentario per il lato ulnare (mignolo).</p>
          <p><b>Dolore:</b> riduce iper-protezione locale.</p>
          <p><b>Muscolo:</b> supporta controllo fine e presa ulnare.</p>
        `,
        patient:`<p>Per il mignolo: un bollino su <b>C8</b>, uno sul dolore e uno sul muscolo del lato del mignolo.</p>`
      }
    },

    ginocchio: {
      mediale: {
        dermatome: "L4",
        pain:   {left:44, top:73},
        muscle: {left:50, top:66},
        muscleName: "Vasto mediale (quadricipite) – stabilità ginocchio",
        scientific: `
          <p><b>L4:</b> riferimento segmentario spesso coerente con dolore antero-mediale ginocchio.</p>
          <p><b>Dolore:</b> riduzione del segnale nocicettivo locale e miglioramento controllo del carico.</p>
          <p><b>Muscolo:</b> facilitazione del vasto mediale per stabilità e tracking rotuleo.</p>
        `,
        patient:`<p>Ginocchio interno: bollino su <b>L4</b>, poi sul dolore e sul muscolo della coscia che stabilizza il ginocchio.</p>`
      },
      laterale: {
        dermatome: "L5",
        pain:   {left:56, top:73},
        muscle: {left:58, top:64},
        muscleName: "Complesso laterale coscia (TFL/ITB) – controllo laterale",
        scientific: `
          <p><b>L5:</b> riferimento segmentario frequente per distretto laterale.</p>
          <p><b>Dolore:</b> riduce compensi e rigidità.</p>
          <p><b>Muscolo:</b> migliora stabilità laterale in appoggio.</p>
        `,
        patient:`<p>Ginocchio esterno: bollino su <b>L5</b>, poi sul dolore e sul muscolo laterale che controlla la stabilità.</p>`
      },
      anteriore: {
        dermatome: "L3",
        pain:   {left:50, top:71},
        muscle: {left:50, top:62},
        muscleName: "Quadricipite (retto femorale/VMO) – estensione ginocchio",
        scientific: `
          <p><b>L3:</b> riferimento segmentario per distretto anteriore.</p>
          <p><b>Dolore:</b> riduce iper-protezione femoro-rotulea.</p>
          <p><b>Muscolo:</b> migliora controllo del quadricipite in flesso-estensione.</p>
        `,
        patient:`<p>Dolore davanti al ginocchio: bollino su <b>L3</b>, poi sul dolore e sul muscolo della coscia.</p>`
      },
      posteriore: {
        dermatome: "S1",
        pain:   {left:50, top:77},
        muscle: {left:52, top:84},
        muscleName: "Gastrocnemio/Soleo – catena posteriore",
        scientific: `
          <p><b>S1:</b> riferimento segmentario frequente per distretto posteriore e catena posteriore.</p>
          <p><b>Dolore:</b> modulazione in cavo popliteo.</p>
          <p><b>Muscolo:</b> normalizza tono del polpaccio collegato al gesto del ginocchio.</p>
        `,
        patient:`<p>Dolore dietro al ginocchio: bollino su <b>S1</b>, poi sul dolore e sul polpaccio.</p>`
      }
    }
  };

  /* ======= STATO + HELPERS ======= */
  const STATE = { step:1, area:"", side:"", zone:"", zoneLabel:"", intensity:"", duration:"", notes:"" };
  const $ = (id)=>document.getElementById(id);

  function showStep(n){
    STATE.step=n;
    ["step1","step2","step3","step4"].forEach((s,i)=>$(s).classList.toggle("active", i===n-1));
    const barSteps = 4;
    const idx = Math.min(n, barSteps);
    $("bar").style.width = (((idx-1)/(barSteps-1))*100) + "%";
  }

  function openModal(meta){
    $("modalTitle").textContent = meta.title || "Dettaglio";
    const c = $("modalChips"); c.innerHTML="";
    (meta.chips||[]).forEach(x=>{ const s=document.createElement("span"); s.className="chip"; s.textContent=x; c.appendChild(s); });
    $("modalVertebra").innerHTML = `Livello / punto: <b>${meta.level || "—"}</b>`;
    $("modalProfBody").innerHTML = meta.scientific || "<p>—</p>";
    $("modalPatientBody").innerHTML = meta.patient || "<p>—</p>";
    $("modalBack").style.display="flex";
  }
  function closeModal(){ $("modalBack").style.display="none"; }
  $("modalClose").addEventListener("click", closeModal);
  $("modalBack").addEventListener("click", (e)=>{ if(e.target===$("modalBack")) closeModal(); });

  function renderZones(){
    const box = $("zones");
    box.innerHTML="";
    (ZONES[STATE.area]||[]).forEach(([val,label,hint])=>{
      const b=document.createElement("button");
      b.type="button";
      b.className="zoneBtn";
      b.dataset.zone=val;
      b.innerHTML=`<b>${label}</b><small>${hint}</small>`;
      b.addEventListener("click", ()=>{
        STATE.zone=val; STATE.zoneLabel=label;
        [...box.querySelectorAll(".zoneBtn")].forEach(x=>x.classList.toggle("selected", x.dataset.zone===val));
      });
      box.appendChild(b);
    });
  }

  function clearMarkers(){
    ["wrapSpine","wrapBody"].forEach(w=>{
      const wrap=$(w);
      [...wrap.querySelectorAll(".marker")].forEach(m=>m.remove());
    });
  }

  function addMarker(wrapId, left, top, meta){
    const wrap = $(wrapId);
    const m = document.createElement("div");
    m.className = "marker show";
    m.style.left = left + "%";
    m.style.top  = top  + "%";
    m.innerHTML = `<div class="dot" title="Tocca per dettagli"></div>`;
    m.addEventListener("click",(ev)=>{ ev.stopPropagation(); openModal(meta); });
    wrap.appendChild(m);
  }

  function setImages(){
    // colonna
    $("spineFallback").style.display="none";
    $("imgSpine").onerror = ()=>{ $("spineFallback").style.display="block"; };
    $("imgSpine").src = IMG.spineSegments;

    // body
    $("bodyFallback").style.display="none";
    $("imgBody").onerror = ()=>{ $("bodyFallback").style.display="block"; };
    $("imgBody").src = IMG.bodyMap;
  }

  function buildSummaryText(pathway){
    return [
      `Area: ${STATE.area}`,
      `Lato: ${STATE.side}`,
      `Zona: ${STATE.zoneLabel}`,
      `Intensità: ${STATE.intensity}`,
      `Durata: ${STATE.duration}`,
      STATE.notes?.trim()?`Note: ${STATE.notes.trim()}`:"Note: —",
      ``,
      `Marker 1 (colonna): ${pathway.dermatome}`,
      `Marker 2 (dolore): ${STATE.zoneLabel}`,
      `Marker 3 (muscolo): ${pathway.muscleName}`
    ].join("\n");
  }

  function setSafety(){
    const n = Number(STATE.intensity);
    const warn=[];
    if(!isNaN(n) && n>=8) warn.push("Dolore molto intenso (8–10): valuta un consulto medico.");
    const box=$("safety");
    if(warn.length){ box.style.display="block"; box.innerHTML = `<b>Attenzione:</b><ul>${warn.map(w=>`<li>${w}</li>`).join("")}</ul>`; }
    else { box.style.display="none"; box.innerHTML=""; }
  }

  /* ======= UI BUTTONS ======= */
  $("next1").addEventListener("click", ()=>{
    const a=$("area").value, s=$("side").value;
    if(!a||!s){ alert("Seleziona area e lato."); return; }
    STATE.area=a; STATE.side=s; STATE.zone=""; STATE.zoneLabel="";
    renderZones();
    showStep(2);
  });

  $("back2").addEventListener("click", ()=>showStep(1));
  $("next2").addEventListener("click", ()=>{
    if(!STATE.zone){ alert("Seleziona una zona."); return; }
    showStep(3);
  });

  $("back3").addEventListener("click", ()=>showStep(2));

  $("next3").addEventListener("click", ()=>{
    const intensity=$("intensity").value;
    const duration=$("duration").value;
    const notes=$("notes").value||"";
    const n=Number(intensity);
    if(intensity===""||isNaN(n)||n<0||n>10){ alert("Inserisci intensità 0–10."); return; }
    if(!duration){ alert("Seleziona la durata."); return; }

    STATE.intensity=intensity;
    STATE.duration=duration;
    STATE.notes=notes;

    const pathway = PATHWAYS[STATE.area]?.[STATE.zone];
    if(!pathway){
      alert("Percorso non definito. (Aggiungilo in PATHWAYS).");
      return;
    }

    setImages();
    clearMarkers();

    // Marker 1: colonna al livello dermatomerico
    const lev = pathway.dermatome;
    const pos = SPINE_LEVEL[lev];
    if(pos){
      addMarker("wrapSpine", pos.left, pos.top, {
        title: `Segmento ${lev} (dermatomero)`,
        level: lev,
        chips: ["colonna","dermatomero", lev],
        scientific: pathway.scientific,
        patient: pathway.patient
      });
    } else {
      // se manca il livello in tabella
      addMarker("wrapSpine", 62, 50, {
        title: `Livello non mappato: ${lev}`,
        level: lev,
        chips: ["colonna","attenzione"],
        scientific: `<p>Manca la coordinata per <b>${lev}</b> in <code>SPINE_LEVEL</code>.</p>`,
        patient: `<p>Serve una piccola correzione tecnica: manca il punto del livello <b>${lev}</b>.</p>`
      });
    }

    // Marker 2: dolore sulla mappa dermatomeri
    addMarker("wrapBody", pathway.pain.left, pathway.pain.top, {
      title: "Punto dolore (distretto)",
      level: "Dolore",
      chips: ["dolore","distretto"],
      scientific: `
        <p><b>Perché qui:</b> localizziamo la sede sintomatica. Lo stimolo agisce sulla componente sensitivo-propriocettiva locale,
        riducendo iper-protezione e migliorando la qualità del movimento.</p>
      `,
      patient: `<p>Questo bollino indica <b>dove senti dolore</b>. Serve per guidarti e monitorare se migliora.</p>`
    });

    // Marker 3: muscolo chiave
    addMarker("wrapBody", pathway.muscle.left, pathway.muscle.top, {
      title: `Muscolo chiave: ${pathway.muscleName}`,
      level: "Muscolo",
      chips: ["muscolo","movimento"],
      scientific: `
        <p><b>Perché qui:</b> il dolore altera il reclutamento. Il punto sul muscolo facilita una sequenza di attivazione più efficiente e riduce co-contrazioni inutili.</p>
        <p><b>Effetto atteso:</b> gesto più economico, meno rigidità, maggiore controllo.</p>
      `,
      patient: `<p>Questo bollino è sul <b>muscolo che muove/stabilizza</b> la zona: aiuta a far lavorare meglio il movimento.</p>`
    });

    $("summary").textContent = buildSummaryText(pathway);
    setSafety();
    showStep(4);
  });

  $("restart").addEventListener("click", ()=>{
    Object.assign(STATE,{step:1,area:"",side:"",zone:"",zoneLabel:"",intensity:"",duration:"",notes:""});
    $("area").value=""; $("side").value="";
    $("zones").innerHTML="";
    $("intensity").value=""; $("duration").value=""; $("notes").value="";
    $("summary").textContent="";
    $("safety").style.display="none"; $("safety").innerHTML="";
    clearMarkers();
    showStep(1);
  });

  $("copy").addEventListener("click", async ()=>{
    const t=$("summary").textContent||"";
    if(!t){ alert("Nulla da copiare."); return; }
    try{ await navigator.clipboard.writeText(t); alert("Testo copiato."); }
    catch(e){ alert("Copia non disponibile: seleziona e copia manualmente."); }
  });

  showStep(1);
</script>
</body>
</html>









