<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dolore + Dermatomeri + Marker (popup professionale + paziente)</title>
  <style>
    :root{--blue:#1f5eff;--bg:#f6f7fb;--card:#fff;--line:#d9dce6;--soft:#eef1ff;--text:#111;--muted:#555;}
    body{font-family:system-ui;margin:0;background:var(--bg);color:var(--text)}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    .card{background:var(--card);border-radius:16px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    h2{margin:0 0 6px}
    .small{font-size:12px;color:var(--muted);line-height:1.35}
    .pill{display:inline-block;background:var(--soft);color:var(--blue);padding:4px 10px;border-radius:999px;font-size:12px;margin-bottom:10px}
    .progress{height:10px;background:#e9ecf7;border-radius:999px;overflow:hidden;margin:12px 0 16px}
    .bar{height:100%;width:0%;background:var(--blue);transition:width .25s ease}
    .step{display:none}
    .step.active{display:block}

    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:980px){.row.two{grid-template-columns:1.05fr .95fr}}
    label{font-size:13px;color:#333;display:block;margin-bottom:6px}
    select,input,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;font-size:16px;background:#fff}
    textarea{min-height:90px;resize:vertical}

    .btnbar{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap}
    button{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-size:16px;cursor:pointer}
    button.primary{background:var(--blue);color:#fff}
    button.secondary{background:var(--soft);color:var(--blue)}
    button.ghost{background:transparent;color:var(--blue);border:1px solid #cfd6ff}

    .zones{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
    @media(min-width:980px){.zones{grid-template-columns:1fr 1fr}}
    .zoneBtn{width:100%;text-align:left;border:1px solid var(--line);background:#fff;border-radius:14px;padding:12px}
    .zoneBtn b{display:block;margin-bottom:6px}
    .zoneBtn small{color:#555}
    .zoneBtn.selected{border-color:var(--blue);box-shadow:0 0 0 3px rgba(31,94,255,.15)}

    .result{background:#f7f9ff;border:1px solid #dfe6ff;padding:12px;border-radius:12px;white-space:pre-wrap}
    .warn{background:#fff5f5;border:1px solid #ffd6d6;color:#7a1b1b;padding:12px;border-radius:12px;margin-top:12px}

    .mapBox{border:1px solid #e6e8f2;border-radius:16px;padding:12px;background:#fff}
    .mapGrid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:980px){.mapGrid{grid-template-columns:1fr 1fr}}
    .pane{border:1px solid #eef1ff;border-radius:16px;padding:10px;background:#fbfcff}
    .pane b{display:block;margin-bottom:6px}

    .imgWrap{position:relative;border-radius:14px;overflow:hidden;border:1px solid rgba(0,0,0,.06);background:#fff}
    .imgWrap img{width:100%;height:auto;display:block}
    .fallback{display:none;padding:10px;font-size:12px;color:#7a1b1b;background:#fff5f5;border-top:1px solid #ffd6d6}

    /* ✅ MARKER: solo bollino piccolo */
    .marker{
      position:absolute;
      transform:translate(-50%,-50%);
      display:none;
      z-index:5;
      pointer-events:auto;
      cursor:pointer;
      touch-action:manipulation;
      user-select:none;
    }
    .marker.show{display:block}
    .dot{
      width:10px;height:10px;border-radius:50%;
      background:var(--blue);
      border:2px solid #fff;
      box-shadow:0 0 0 3px rgba(31,94,255,.16);
    }
    .dot:hover{
      box-shadow:0 0 0 5px rgba(31,94,255,.18);
    }

    /* Modal */
    .modalBack{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:18px;z-index:99}
    .modal{max-width:820px;width:100%;background:#fff;border-radius:16px;padding:14px;box-shadow:0 20px 60px rgba(0,0,0,.25)}
    .modalHeader{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .closeBtn{background:transparent;border:1px solid #ddd;border-radius:10px;padding:6px 10px;font-size:14px;cursor:pointer}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
    .chip{background:var(--soft);color:var(--blue);padding:4px 10px;border-radius:999px;font-size:12px}
    .modalBody{font-size:14px;line-height:1.5;color:#222}
    .sec{border:1px solid #eef1ff;border-radius:14px;padding:12px;background:#fbfcff;margin-top:10px}
    .secTitle{font-weight:700;margin:0 0 6px}
    .patient{
      color:var(--blue);
      font-style:italic;
      background:#f7f9ff;
      border-color:#dfe6ff;
    }
    .vertebraLine{
      margin-top:10px;
      padding:10px;
      border-radius:12px;
      border:1px solid #e6e8f2;
      background:#fff;
    }
    .vertebraLine b{color:var(--blue)}
    code{background:#f1f3ff;padding:2px 6px;border-radius:8px}

    /* Posologia card */
    .doseCard{background:#fff;border:1px solid #e6e8f2;border-radius:16px;padding:12px;margin-top:12px}
    .doseCard ul{margin:8px 0 0;padding-left:18px}
    .doseCard li{margin:6px 0}
    .doseWarn{background:#fff5f5;border:1px solid #ffd6d6;color:#7a1b1b;border-radius:14px;padding:10px;margin-top:10px}
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h2>Demo — domande dolore + mappe + marker (popup)</h2>
    <div class="small">Tocca i bollini blu: si apre una spiegazione professionale + una spiegazione semplice per il paziente + vertebra/punto.</div>

    <div class="progress"><div class="bar" id="bar"></div></div>

    <!-- STEP 1 -->
    <section class="step active" id="step1">
      <div class="pill">Passo 1/4</div>
      <p><b>Dove senti dolore?</b></p>

      <div class="row two">
        <div>
          <label>Area</label>
          <select id="area">
            <option value="">Seleziona…</option>
            <option value="ginocchio">Ginocchio</option>
            <option value="anca">Anca</option>
            <option value="lombare">Schiena bassa (lombare)</option>
            <option value="cervicale">Collo (cervicale)</option>
            <option value="spalla">Spalla</option>
            <option value="mano">Mano / dita</option>
          </select>
        </div>
        <div>
          <label>Lato</label>
          <select id="side">
            <option value="">Seleziona…</option>
            <option value="sinistro">Sinistro</option>
            <option value="destro">Destro</option>
            <option value="bilaterale">Bilaterale</option>
            <option value="centrale">Centrale</option>
          </select>
        </div>
      </div>

      <div class="btnbar">
        <button class="primary" type="button" id="next1">Avanti</button>
      </div>
    </section>

    <!-- STEP 2 -->
    <section class="step" id="step2">
      <div class="pill">Passo 2/4</div>
      <p><b>Seleziona la zona</b></p>
      <div class="zones" id="zones"></div>

      <div class="btnbar">
        <button class="secondary" type="button" id="back2">Indietro</button>
        <button class="primary" type="button" id="next2">Avanti</button>
      </div>
    </section>

    <!-- STEP 3 -->
    <section class="step" id="step3">
      <div class="pill">Passo 3/4</div>
      <p><b>Dettagli</b></p>

      <div class="row two">
        <div>
          <label>Intensità (0–10)</label>
          <input id="intensity" type="number" min="0" max="10" step="1" placeholder="Es. 6">
        </div>
        <div>
          <label>Da quanto tempo?</label>
          <select id="duration">
            <option value="">Seleziona…</option>
            <option value="<24h">Meno di 24 ore</option>
            <option value="1-3g">1–3 giorni</option>
            <option value="4-14g">4–14 giorni</option>
            <option value=">2s">Oltre 2 settimane</option>
            <option value=">3m">Oltre 3 mesi</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Note (facoltativo)</label>
          <textarea id="notes" placeholder="Cosa lo peggiora/migliora?"></textarea>
        </div>
      </div>

      <div class="btnbar">
        <button class="secondary" type="button" id="back3">Indietro</button>
        <button class="primary" type="button" id="next3">Vedi guida</button>
      </div>
    </section>

    <!-- STEP 4 -->
    <section class="step" id="step4">
      <div class="pill">Passo 4/4</div>
      <p><b>Guida</b></p>

      <div class="row two">
        <div>
          <div class="result" id="summary"></div>
          <div class="warn" id="safety" style="display:none;"></div>

          <div class="doseCard" id="doseInline"></div>

          <div class="btnbar">
            <button class="ghost" type="button" id="restart">Ricomincia</button>
            <button class="primary" type="button" id="copy">Copia testo</button>
            <button class="secondary" type="button" id="btnTiming">Tempi di applicazione</button>
          </div>

          <div class="small" style="margin-top:10px;">
            <b>Riferimento palpatorio L4–L5:</b><br>
            linea tra le <b>creste iliache</b> ≈ L4. Lo spazio <b>L4–L5</b> è subito sotto.
          </div>
        </div>

        <div class="mapBox">
          <div class="mapGrid">

            <div class="pane">
              <b>Mappa dermatomeri (vista automatica)</b>
              <div class="imgWrap" id="wrapDerm">
                <img id="imgDerm" alt="Dermatomeri">
              </div>
            </div>

            <div class="pane">
              <b>Colonna vertebrale (L4–L5)</b>
              <div class="imgWrap" id="wrapSpine">
                <img id="imgSpine" alt="Colonna L4 L5">
                <div class="fallback" id="spineFallback">
                  <b>Immagine colonna non trovata.</b><br>
                  Nome file richiesto: <code>colonna L4 L5.png</code> (stessa cartella di <code>index.html</code>).
                </div>
              </div>
            </div>

            <div class="pane">
              <b>Arti inferiori</b>
              <div class="imgWrap" id="wrapLower">
                <img id="imgLower" alt="Arti inferiori">
              </div>
            </div>

            <div class="pane">
              <b>Arti superiori</b>
              <div class="imgWrap" id="wrapUpper">
                <img id="imgUpper" alt="Arti superiori">
              </div>
            </div>

          </div>
        </div>
      </div>
    </section>

    <!-- STEP 5 -->
    <section class="step" id="step5">
      <div class="pill">Tempi di applicazione</div>

      <div class="doseCard">
        <b>Protocollo base</b>
        <ul>
          <li><b>Mattina:</b> 2 ore</li>
          <li><b>Sera:</b> 2 ore</li>
          <li><b>Se dolore persiste:</b> possibile estensione <b>anche tutta la notte</b></li>
        </ul>

        <div class="doseCard" style="margin-top:10px;background:#f7f9ff;border-color:#dfe6ff">
          <b>Schema settimanale</b>
          <ul>
            <li><b>5 giorni</b> con applicazione</li>
            <li><b>2 giorni</b> di riposo senza dispositivi</li>
          </ul>
        </div>

        <div class="doseWarn">
          <b>Se non tollerato</b> (mal di testa, stanchezza, nausea o dolore peggiore):<br>
          1) <b>Rimuovere</b> i dispositivi<br>
          2) Attendere che i sintomi rientrino<br>
          3) Riprovare con <b>meno ore</b> (es. 30–60 min) e aumentare gradualmente se tollerato
        </div>

        <div class="btnbar">
          <button class="secondary" type="button" id="backTiming">Indietro</button>
          <button class="primary" type="button" id="backToGuide">Ritorna alla guida</button>
        </div>
      </div>
    </section>

  </div>
</div>

<!-- MODAL -->
<div class="modalBack" id="modalBack">
  <div class="modal">
    <div class="modalHeader">
      <b id="modalTitle">Dettaglio</b>
      <button class="closeBtn" id="modalClose" type="button">Chiudi</button>
    </div>
    <div class="chips" id="modalChips"></div>

    <div class="modalBody">
      <div class="vertebraLine" id="modalVertebra"></div>

      <div class="sec" id="modalProf">
        <div class="secTitle">Razionale scientifico / professionale</div>
        <div id="modalProfBody"></div>
      </div>

      <div class="sec patient" id="modalPatient">
        <div class="secTitle">Spiegazione semplice per il paziente</div>
        <div id="modalPatientBody"></div>
      </div>
    </div>
  </div>
</div>

<script>
  const IMG = {
    front: "https://www.laguardiamedica.it/2019/contenuti/neurologia/images/derm_01.jpg",
    back:  "https://www.laguardiamedica.it/2019/contenuti/neurologia/images/derm_02.jpg",
    upper: "https://www.laguardiamedica.it/2019/contenuti/neurologia/images/derm_03.jpg",
    lower: "https://www.laguardiamedica.it/2019/contenuti/neurologia/images/derm_04.jpg",
    spine: "./colonna%20L4%20L5.png"
  };

  const DOSING = {
    morningHours: 2, eveningHours: 2,
    allowNightIfPersist: true,
    cycleOnDays: 5, cycleOffDays: 2,
    intolerance: ["mal di testa","stanchezza","nausea","dolore peggiore"]
  };

  function dosingHtml(){
    return `
      <b>Posologia (tempi di applicazione)</b>
      <ul>
        <li><b>Mattina:</b> ${DOSING.morningHours} ore</li>
        <li><b>Sera:</b> ${DOSING.eveningHours} ore</li>
        <li><b>Se dolore persiste:</b> anche tutta la notte</li>
        <li><b>Ciclo:</b> ${DOSING.cycleOnDays} giorni ON + ${DOSING.cycleOffDays} giorni OFF</li>
      </ul>
      <div class="doseWarn">
        <b>Se non tollerato</b> (${DOSING.intolerance.join(", ")}): rimuovere e riprovare con meno ore.
      </div>
    `;
  }

  function dosingText(){
    return [
      "Posologia:",
      `- Mattina: ${DOSING.morningHours} ore`,
      `- Sera: ${DOSING.eveningHours} ore`,
      `- Se dolore persiste: anche tutta la notte`,
      `- Ciclo: ${DOSING.cycleOnDays} giorni ON + ${DOSING.cycleOffDays} giorni OFF`,
      `- Se non tollerato (mal di testa / stanchezza / nausea / dolore peggiore): rimuovere e riprovare con meno ore`
    ].join("\n");
  }

  const ZONES = {
    ginocchio: [
      ["mediale","Ginocchio interno (mediale)","dolore lato interno"],
      ["laterale","Ginocchio esterno (laterale)","dolore lato esterno"],
      ["anteriore","Ginocchio anteriore (rotula)","dolore davanti"],
      ["posteriore","Ginocchio posteriore (cavo popliteo)","dolore dietro"]
    ],
    anca: [
      ["inguine","Anca anteriore / inguine","dolore davanti anca"],
      ["laterale","Anca laterale (trocantere)","dolore lato anca"],
      ["gluteo","Anca posteriore / gluteo","dolore dietro anca"]
    ],
    lombare: [
      ["centrale","Lombare centrale","dolore in mezzo"],
      ["paravertebrale","Lombare paravertebrale","dolore a lato colonna"],
      ["sacroiliaca","Sacro-iliaca","dolore su SI"]
    ],
    cervicale: [
      ["alta","Cervicale alta","nuca/occipite"],
      ["bassa","Cervicale bassa","base collo"],
      ["scapolare","Tra collo e scapola","dolore scapolare"]
    ],
    spalla: [
      ["anteriore","Spalla anteriore","davanti spalla"],
      ["laterale","Spalla laterale","deltoide"],
      ["posteriore","Spalla posteriore","dietro spalla"]
    ],
    mano: [
      ["pollice","Pollice","territorio C6 (radiale)"],
      ["indice","Indice","C6"],
      ["medio","Medio","C7"],
      ["ulnare","Anulare/Mignolo","C8–T1"]
    ]
  };

  /* coordinate marker (modificabili) */
  const DEFAULT_POS = {
    spine_L4L5:{wrap:"spine", left:26, top:78},
    spine_S1:{wrap:"spine", left:24, top:90},
    derm_L4L5:{wrap:"derm", left:50, top:62},
    derm_S1:{wrap:"derm", left:50, top:80},

    knee_med:{wrap:"lower", left:44, top:44},
    knee_lat:{wrap:"lower", left:56, top:44},
    knee_ant:{wrap:"lower", left:50, top:40},
    knee_post:{wrap:"lower", left:50, top:48},

    hip_inguine:{wrap:"lower", left:50, top:28},
    hip_lat:{wrap:"lower", left:58, top:30},
    hip_gluteo:{wrap:"lower", left:50, top:32},

    shoulder_ant:{wrap:"upper", left:22, top:16},
    shoulder_lat:{wrap:"upper", left:20, top:18},
    shoulder_post:{wrap:"upper", left:18, top:16},

    hand_thumb:{wrap:"upper", left:74, top:90},
    hand_index:{wrap:"upper", left:72, top:86},
    hand_middle:{wrap:"upper", left:70, top:82},
    hand_ulnar:{wrap:"upper", left:66, top:86}
  };

  const STATE = { step:1, area:"", side:"", zone:"", zoneLabel:"", intensity:"", duration:"", notes:"" };
  const $ = (id)=>document.getElementById(id);

  function showStep(n){
    STATE.step=n;
    ["step1","step2","step3","step4","step5"].forEach((s,i)=>$(s).classList.toggle("active", i===n-1));
    const barSteps = 4;
    const idx = Math.min(n, barSteps);
    $("bar").style.width = (((idx-1)/(barSteps-1))*100) + "%";
  }

  function openModal(meta){
    $("modalTitle").textContent = meta.title || "Dettaglio";

    const c = $("modalChips"); c.innerHTML="";
    (meta.chips||[]).forEach(x=>{
      const s=document.createElement("span");
      s.className="chip";
      s.textContent=x;
      c.appendChild(s);
    });

    $("modalVertebra").innerHTML = meta.vertebra
      ? `Punto / vertebra di applicazione: <b>${meta.vertebra}</b>`
      : `Punto / vertebra di applicazione: <b>—</b>`;

    $("modalProfBody").innerHTML = meta.profHtml || "<p>—</p>";
    $("modalPatientBody").innerHTML = meta.patientHtml || "<p>—</p>";

    $("modalBack").style.display="flex";
  }
  function closeModal(){ $("modalBack").style.display="none"; }
  $("modalClose").addEventListener("click", closeModal);
  $("modalBack").addEventListener("click", (e)=>{ if(e.target===$("modalBack")) closeModal(); });

  function renderZones(){
    const box = $("zones");
    box.innerHTML="";
    (ZONES[STATE.area]||[]).forEach(([val,label,hint])=>{
      const b=document.createElement("button");
      b.type="button";
      b.className="zoneBtn";
      b.dataset.zone=val;
      b.innerHTML=`<b>${label}</b><small>${hint}</small>`;
      b.addEventListener("click", ()=>{
        STATE.zone=val; STATE.zoneLabel=label;
        [...box.querySelectorAll(".zoneBtn")].forEach(x=>x.classList.toggle("selected", x.dataset.zone===val));
      });
      box.appendChild(b);
    });
  }

  function clearMarkers(){
    ["wrapDerm","wrapSpine","wrapLower","wrapUpper"].forEach(w=>{
      const wrap=$(w);
      [...wrap.querySelectorAll(".marker")].forEach(m=>m.remove());
    });
  }

  function wrapByName(name){
    if(name==="derm") return $("wrapDerm");
    if(name==="spine") return $("wrapSpine");
    if(name==="lower") return $("wrapLower");
    if(name==="upper") return $("wrapUpper");
    return $("wrapDerm");
  }

  function addMarker(key, meta){
    const def = DEFAULT_POS[key];
    if(!def) return;
    const wrap = wrapByName(def.wrap);

    const m = document.createElement("div");
    m.className = "marker show";
    m.style.left = def.left + "%";
    m.style.top  = def.top + "%";
    m.innerHTML = `<div class="dot" title="Tocca per dettagli"></div>`;

    m.addEventListener("click",(ev)=>{
      ev.stopPropagation();
      openModal(meta);
    });

    wrap.appendChild(m);
  }

  function setImages(dermView){
    $("imgDerm").src  = dermView==="front" ? IMG.front : dermView==="upper" ? IMG.upper : dermView==="lower" ? IMG.lower : IMG.back;
    $("imgLower").src = IMG.lower;
    $("imgUpper").src = IMG.upper;

    $("spineFallback").style.display="none";
    $("imgSpine").onerror = ()=>{ $("spineFallback").style.display="block"; };
    $("imgSpine").src = IMG.spine;
  }

  function addBaseL4L5(points, markers){
    points.push("1) Prima applicazione: L4–L5 (obbligatoria)");
    markers.push({
      key:"spine_L4L5",
      meta:{
        title:"L4–L5 (prima applicazione)",
        vertebra:"L4–L5",
        chips:["L4–L5","colonna"],
        profHtml:`
          <p><b>Obiettivo:</b> riferimento segmentario lombare basso per modulazione afferente segmentaria e miglior controllo lombo-pelvico.</p>
          <p><b>Razionalità clinica:</b> riduzione dei compensi e miglioramento del pattern di carico dell’arto (in funzione dell’area dolorosa scelta).</p>
        `,
        patientHtml:`
          <p>Metti il primo dispositivo <b>alla base della schiena</b>, nel punto indicato come <b>L4–L5</b>.
          Serve a “calmare” i segnali che mantengono la tensione e a rendere il movimento più stabile.</p>
        `
      }
    });

    markers.push({
      key:"derm_L4L5",
      meta:{
        title:"L4–L5 (guida dermatomeri)",
        vertebra:"L4–L5",
        chips:["mappa","orientamento"],
        profHtml:`<p>Marker regionale su mappa dermatomeri: guida visiva, non punto millimetrico.</p>`,
        patientHtml:`<p>Questo bollino serve solo a <b>orientarti</b> sulla mappa del corpo.</p>`
      }
    });
  }

  function buildPlan(){
    const area = STATE.area;
    const zone = STATE.zone;
    let dermView="back";
    const markers=[];
    const points=[];

    addBaseL4L5(points, markers);

    if(area==="ginocchio"){
      dermView="back";
      const painKey = zone==="mediale" ? "knee_med" : zone==="laterale" ? "knee_lat" : zone==="anteriore" ? "knee_ant" : "knee_post";

      points.push("2) Seconda applicazione: S1 (sacro)");
      markers.push({
        key:"spine_S1",
        meta:{
          title:"S1 (seconda applicazione)",
          vertebra:"S1",
          chips:["S1","sacro"],
          profHtml:`<p><b>Obiettivo:</b> supporto del controllo lombo-sacrale e integrazione catena posteriore.</p>`,
          patientHtml:`<p>Metti il secondo dispositivo sul <b>sacro</b> (alla base della schiena).
          Aiuta a rendere più stabile bacino e appoggio.</p>`
        }
      });
      markers.push({
        key:"derm_S1",
        meta:{
          title:"S1 (guida dermatomeri)",
          vertebra:"S1",
          chips:["mappa","orientamento"],
          profHtml:`<p>Guida regionale su mappa dermatomeri.</p>`,
          patientHtml:`<p>Questo bollino serve solo per orientarti sulla mappa.</p>`
        }
      });

      points.push("Zona dolore: ginocchio (marker orientativo)");
      markers.push({
        key:painKey,
        meta:{
          title:"Zona dolore (ginocchio)",
          vertebra:"—",
          chips:["dolore","arto inferiore"],
          profHtml:`<p>Marker orientativo della sede riferita: utile per correlazione clinica e monitoraggio.</p>`,
          patientHtml:`<p>Qui è dove tu senti il dolore (serve per ricordare e monitorare).</p>`
        }
      });
    }

    else if(area==="mano"){
      dermView="upper";
      const painKey = zone==="pollice" ? "hand_thumb" : zone==="indice" ? "hand_index" : zone==="medio" ? "hand_middle" : "hand_ulnar";

      points.push("Zona dolore: mano/dita (marker orientativo)");
      markers.push({
        key:painKey,
        meta:{
          title:`Zona dolore (${STATE.zoneLabel})`,
          vertebra:"—",
          chips:["dolore","mano"],
          profHtml:`<p>Marker orientativo per distretto mano/dita (utile a tracciare l’evoluzione dei sintomi).</p>`,
          patientHtml:`<p>Questo bollino indica dove senti il dolore nella mano.</p>`
        }
      });
    }

    else if(area==="anca"){
      dermView="back";
      const painKey = zone==="inguine" ? "hip_inguine" : zone==="laterale" ? "hip_lat" : "hip_gluteo";
      points.push("Zona dolore: anca (marker orientativo)");
      markers.push({
        key:painKey,
        meta:{
          title:"Zona dolore (anca)",
          vertebra:"—",
          chips:["dolore","anca"],
          profHtml:`<p>Marker orientativo del dolore d’anca riferito.</p>`,
          patientHtml:`<p>Questo bollino indica dove senti dolore all’anca.</p>`
        }
      });
    }

    else if(area==="spalla"){
      dermView="upper";
      const painKey = zone==="anteriore" ? "shoulder_ant" : zone==="laterale" ? "shoulder_lat" : "shoulder_post";
      points.push("Zona dolore: spalla (marker orientativo)");
      markers.push({
        key:painKey,
        meta:{
          title:"Zona dolore (spalla)",
          vertebra:"—",
          chips:["dolore","spalla"],
          profHtml:`<p>Marker orientativo per distretto spalla.</p>`,
          patientHtml:`<p>Questo bollino indica dove senti dolore alla spalla.</p>`
        }
      });
    }

    else if(area==="lombare"){
      dermView="back";
      points.push("2) (Opzionale) S1 se dolore sacrale");
      markers.push({
        key:"spine_S1",
        meta:{
          title:"S1 (opzionale)",
          vertebra:"S1",
          chips:["S1","opzionale"],
          profHtml:`<p>Se componente sacrale, aggiunta di riferimento S1 (demo).</p>`,
          patientHtml:`<p>Se il dolore è molto in basso, vicino al sacro, può essere utile aggiungere questo punto.</p>`
        }
      });
      markers.push({
        key:"derm_S1",
        meta:{
          title:"S1 (mappa)",
          vertebra:"S1",
          chips:["mappa"],
          profHtml:`<p>Guida regionale su mappa.</p>`,
          patientHtml:`<p>Solo orientamento sulla mappa.</p>`
        }
      });
    }

    else if(area==="cervicale"){
      dermView="back";
      points.push("Nota: immagine colonna caricata è lombosacrale (non cervicale).");
    }

    return { dermView, markers, points };
  }

  function buildSummary(points){
    const lines = [
      `Area: ${STATE.area}`,
      `Lato: ${STATE.side}`,
      `Zona: ${STATE.zoneLabel || "—"}`,
      `Intensità: ${STATE.intensity}`,
      `Durata: ${STATE.duration}`,
      STATE.notes?.trim()?`Note: ${STATE.notes.trim()}`:"Note: —",
      ``,
      `Punti (ordine):`,
      ...(points.length?points:["—"]),
      ``,
      dosingText(),
      ``,
      "Nota: tocca i bollini blu sulle immagini per aprire spiegazione professionale + spiegazione paziente + vertebra/punto."
    ];
    return lines.join("\n");
  }

  function setSafety(){
    const n = Number(STATE.intensity);
    const warn=[];
    if(!isNaN(n) && n>=8) warn.push("Dolore molto intenso (8–10): valuta un consulto medico.");
    const box=$("safety");
    if(warn.length){
      box.style.display="block";
      box.innerHTML = `<b>Attenzione:</b><ul>${warn.map(w=>`<li>${w}</li>`).join("")}</ul>`;
    } else { box.style.display="none"; box.innerHTML=""; }
  }

  // Buttons
  $("next1").addEventListener("click", ()=>{
    const a=$("area").value, s=$("side").value;
    if(!a||!s){ alert("Seleziona area e lato."); return; }
    STATE.area=a; STATE.side=s; STATE.zone=""; STATE.zoneLabel="";
    renderZones();
    showStep(2);
  });

  $("back2").addEventListener("click", ()=>showStep(1));
  $("next2").addEventListener("click", ()=>{
    if(!STATE.zone){ alert("Seleziona una zona."); return; }
    showStep(3);
  });

  $("back3").addEventListener("click", ()=>showStep(2));
  $("next3").addEventListener("click", ()=>{
    const intensity=$("intensity").value;
    const duration=$("duration").value;
    const notes=$("notes").value||"";
    const n=Number(intensity);
    if(intensity===""||isNaN(n)||n<0||n>10){ alert("Inserisci intensità 0–10."); return; }
    if(!duration){ alert("Seleziona la durata."); return; }

    STATE.intensity=intensity;
    STATE.duration=duration;
    STATE.notes=notes;

    const plan = buildPlan();
    setImages(plan.dermView);

    clearMarkers();
    plan.markers.forEach(m=>addMarker(m.key, m.meta));

    $("summary").textContent = buildSummary(plan.points);
    $("doseInline").innerHTML = dosingHtml();
    setSafety();

    showStep(4);
  });

  $("restart").addEventListener("click", ()=>{
    Object.assign(STATE,{step:1,area:"",side:"",zone:"",zoneLabel:"",intensity:"",duration:"",notes:""});
    $("area").value=""; $("side").value="";
    $("zones").innerHTML="";
    $("intensity").value=""; $("duration").value=""; $("notes").value="";
    $("summary").textContent="";
    $("doseInline").innerHTML="";
    $("safety").style.display="none"; $("safety").innerHTML="";
    clearMarkers();
    showStep(1);
  });

  $("copy").addEventListener("click", async ()=>{
    const t=$("summary").textContent||"";
    if(!t){ alert("Nulla da copiare."); return; }
    try{ await navigator.clipboard.writeText(t); alert("Testo copiato."); }
    catch(e){ alert("Copia non disponibile: seleziona e copia manualmente."); }
  });

  // Timing page
  $("btnTiming").addEventListener("click", ()=>showStep(5));
  $("backTiming").addEventListener("click", ()=>showStep(4));
  $("backToGuide").addEventListener("click", ()=>showStep(4));

  // Init
  showStep(1);
</script>
</body>
</html>







