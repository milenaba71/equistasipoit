<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Marker dermatomero su colonna + dolore + muscolo</title>
  <style>
    :root{--blue:#1f5eff;--bg:#f6f7fb;--card:#fff;--line:#d9dce6;--soft:#eef1ff;--text:#111;--muted:#555;}
    body{font-family:system-ui;margin:0;background:var(--bg);color:var(--text)}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    .card{background:var(--card);border-radius:16px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    h2{margin:0 0 6px}
    .small{font-size:12px;color:var(--muted);line-height:1.35}
    .pill{display:inline-block;background:var(--soft);color:var(--blue);padding:4px 10px;border-radius:999px;font-size:12px;margin-bottom:10px}
    .progress{height:10px;background:#e9ecf7;border-radius:999px;overflow:hidden;margin:12px 0 16px}
    .bar{height:100%;width:0%;background:var(--blue);transition:width .25s ease}
    .step{display:none}
    .step.active{display:block}

    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:980px){.row.two{grid-template-columns:1.05fr .95fr}}

    label{font-size:13px;color:#333;display:block;margin-bottom:6px}
    select,input,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;font-size:16px;background:#fff}
    textarea{min-height:90px;resize:vertical}

    .btnbar{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap}
    button{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-size:16px;cursor:pointer}
    button.primary{background:var(--blue);color:#fff}
    button.secondary{background:var(--soft);color:var(--blue)}
    button.ghost{background:transparent;color:var(--blue);border:1px solid #cfd6ff}

    .zones{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
    @media(min-width:980px){.zones{grid-template-columns:1fr 1fr}}
    .zoneBtn{width:100%;text-align:left;border:1px solid var(--line);background:#fff;border-radius:14px;padding:12px}
    .zoneBtn b{display:block;margin-bottom:6px}
    .zoneBtn small{color:#555}
    .zoneBtn.selected{border-color:var(--blue);box-shadow:0 0 0 3px rgba(31,94,255,.15)}

    .result{background:#f7f9ff;border:1px solid #dfe6ff;padding:12px;border-radius:12px;white-space:pre-wrap}
    .warn{background:#fff5f5;border:1px solid #ffd6d6;color:#7a1b1b;padding:12px;border-radius:12px;margin-top:12px}

    .mapBox{border:1px solid #e6e8f2;border-radius:16px;padding:12px;background:#fff}
    .mapGrid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:980px){.mapGrid{grid-template-columns:1fr 1fr}}
    .pane{border:1px solid #eef1ff;border-radius:16px;padding:10px;background:#fbfcff}
    .pane b{display:block;margin-bottom:6px}

    .imgWrap{position:relative;border-radius:14px;overflow:hidden;border:1px solid rgba(0,0,0,.06);background:#fff}
    .imgWrap img{width:100%;height:auto;display:block}
    .fallback{display:none;padding:10px;font-size:12px;color:#7a1b1b;background:#fff5f5;border-top:1px solid #ffd6d6}

    /* ✅ MARKER: bollino blu piccolissimo */
    .marker{
      position:absolute; transform:translate(-50%,-50%);
      display:none; z-index:20; pointer-events:auto;
      cursor:pointer; touch-action:manipulation; user-select:none;
    }
    .marker.show{display:block}
    .dot{
      width:9px;height:9px;border-radius:50%;
      background:var(--blue);
      border:2px solid #fff;
      box-shadow:0 0 0 3px rgba(31,94,255,.14);
    }
    .dot:hover{box-shadow:0 0 0 5px rgba(31,94,255,.18);}

    /* Modal */
    .modalBack{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:18px;z-index:99}
    .modal{max-width:860px;width:100%;background:#fff;border-radius:16px;padding:14px;box-shadow:0 20px 60px rgba(0,0,0,.25)}
    .modalHeader{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .closeBtn{background:transparent;border:1px solid #ddd;border-radius:10px;padding:6px 10px;font-size:14px;cursor:pointer}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
    .chip{background:var(--soft);color:var(--blue);padding:4px 10px;border-radius:999px;font-size:12px}
    .modalBody{font-size:14px;line-height:1.5;color:#222}
    .sec{border:1px solid #eef1ff;border-radius:14px;padding:12px;background:#fbfcff;margin-top:10px}
    .secTitle{font-weight:700;margin:0 0 6px}
    .patient{color:var(--blue);font-style:italic;background:#f7f9ff;border-color:#dfe6ff}
    .vertebraLine{margin-top:6px;padding:10px;border-radius:12px;border:1px solid #e6e8f2;background:#fff}
    .vertebraLine b{color:var(--blue)}
    code{background:#f1f3ff;padding:2px 6px;border-radius:8px}
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h2>Demo — 3 marker (colonna dermatomero + dolore + muscolo)</h2>
    <div class="small">I marker sono solo bollini blu piccoli. Tocca il bollino per aprire il popup con spiegazione scientifica.</div>

    <div class="progress"><div class="bar" id="bar"></div></div>

    <!-- STEP 1 -->
    <section class="step active" id="step1">
      <div class="pill">Passo 1/4</div>
      <p><b>Dove senti dolore?</b></p>

      <div class="row two">
        <div>
          <label>Area</label>
          <select id="area">
            <option value="">Seleziona…</option>
            <option value="mano">Mano / dita</option>
            <option value="ginocchio">Ginocchio</option>
          </select>
        </div>
        <div>
          <label>Lato</label>
          <select id="side">
            <option value="">Seleziona…</option>
            <option value="sinistro">Sinistro</option>
            <option value="destro">Destro</option>
            <option value="bilaterale">Bilaterale</option>
          </select>
        </div>
      </div>

      <div class="btnbar">
        <button class="primary" type="button" id="next1">Avanti</button>
      </div>
    </section>

    <!-- STEP 2 -->
    <section class="step" id="step2">
      <div class="pill">Passo 2/4</div>
      <p><b>Seleziona la zona</b></p>
      <div class="zones" id="zones"></div>

      <div class="btnbar">
        <button class="secondary" type="button" id="back2">Indietro</button>
        <button class="primary" type="button" id="next2">Avanti</button>
      </div>
    </section>

    <!-- STEP 3 -->
    <section class="step" id="step3">
      <div class="pill">Passo 3/4</div>
      <p><b>Dettagli</b></p>

      <div class="row two">
        <div>
          <label>Intensità (0–10)</label>
          <input id="intensity" type="number" min="0" max="10" step="1" placeholder="Es. 6">
        </div>
        <div>
          <label>Da quanto tempo?</label>
          <select id="duration">
            <option value="">Seleziona…</option>
            <option value="<24h">Meno di 24 ore</option>
            <option value="1-3g">1–3 giorni</option>
            <option value="4-14g">4–14 giorni</option>
            <option value=">2s">Oltre 2 settimane</option>
            <option value=">3m">Oltre 3 mesi</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Note (facoltativo)</label>
          <textarea id="notes" placeholder="Cosa lo peggiora/migliora?"></textarea>
        </div>
      </div>

      <div class="btnbar">
        <button class="secondary" type="button" id="back3">Indietro</button>
        <button class="primary" type="button" id="next3">Vedi marker</button>
      </div>
    </section>

    <!-- STEP 4 -->
    <section class="step" id="step4">
      <div class="pill">Passo 4/4</div>
      <p><b>Marker (3 punti)</b></p>

      <div class="row two">
        <div>
          <div class="result" id="summary"></div>
          <div class="warn" id="safety" style="display:none;"></div>

          <div class="btnbar">
            <button class="ghost" type="button" id="restart">Ricomincia</button>
            <button class="primary" type="button" id="copy">Copia testo</button>
          </div>

          <div class="small" style="margin-top:10px;">
            <b>Nota immagini:</b> per vedere i marker su C7 ecc, carica nel repo <code>colonna_segmenti.png</code>.
          </div>
        </div>

        <div class="mapBox">
          <div class="mapGrid">
            <div class="pane">
              <b>Colonna — segmenti (C…T…L…S)</b>
              <div class="imgWrap" id="wrapSpine">
                <img id="imgSpine" alt="Colonna segmenti">
                <div class="fallback" id="spineFallback">
                  <b>Immagine non trovata.</b><br>
                  Carica nel repo: <code>colonna_segmenti.png</code>
                </div>
              </div>
            </div>

            <div class="pane">
              <b>Mappa distretto (arti sup/inf)</b>
              <div class="imgWrap" id="wrapBody">
                <img id="imgBody" alt="Distretto">
              </div>
              <div class="small">Qui compariranno 2 marker: dolore + muscolo.</div>
            </div>
          </div>
        </div>

      </div>
    </section>

  </div>
</div>

<!-- MODAL -->
<div class="modalBack" id="modalBack">
  <div class="modal">
    <div class="modalHeader">
      <b id="modalTitle">Dettaglio</b>
      <button class="closeBtn" id="modalClose" type="button">Chiudi</button>
    </div>
    <div class="chips" id="modalChips"></div>

    <div class="modalBody">
      <div class="vertebraLine" id="modalVertebra"></div>

      <div class="sec" id="modalProf">
        <div class="secTitle">Spiegazione scientifica / professionale</div>
        <div id="modalProfBody"></div>
      </div>

      <div class="sec patient" id="modalPatient">
        <div class="secTitle">Spiegazione per il paziente</div>
        <div id="modalPatientBody"></div>
      </div>
    </div>
  </div>
</div>

<script>
  /* ========== IMMAGINI ========== */
  const IMG = {
    spineSegments: "./colonna_segmenti.png",  // ✅ devi caricarla nel repo
    upper: "https://www.laguardiamedica.it/2019/contenuti/neurologia/images/derm_03.jpg",
    lower: "https://www.laguardiamedica.it/2019/contenuti/neurologia/images/derm_04.jpg",
  };

  /* ========== ZONE UI ========== */
  const ZONES = {
    mano: [
      ["pollice","Pollice","dermatomero prevalente C6"],
      ["indice","Indice","dermatomero prevalente C6"],
      ["medio","Dito medio","dermatomero prevalente C7"],
      ["anulare","Anulare","dermatomero C7–C8 (variabile)"],
      ["mignolo","Mignolo","dermatomero prevalente C8"]
    ],
    ginocchio: [
      ["mediale","Ginocchio interno (mediale)","prevalenza L3–L4 (variabile)"],
      ["laterale","Ginocchio esterno (laterale)","prevalenza L5 (variabile)"],
      ["anteriore","Ginocchio anteriore (rotula)","prevalenza L3–L4"],
      ["posteriore","Ginocchio posteriore (cavo)","prevalenza S1–L5 (variabile)"]
    ]
  };

  /* ========== MAPPA “SEGMENTO SPINALE -> COORDINATE” (percentuali sull’immagine colonna_segmenti.png)
     Questi valori sono una base: se il tuo file è ritagliato diversamente, basta correggere TOP di pochi punti.
  ========== */
  const SPINE_LEVEL = {
    C2:{left:62, top:10}, C3:{left:62, top:13}, C4:{left:62, top:16}, C5:{left:62, top:19}, C6:{left:62, top:22}, C7:{left:62, top:25}, C8:{left:62, top:28},
    T1:{left:62, top:31}, T2:{left:62, top:34}, T3:{left:62, top:37}, T4:{left:62, top:40}, T5:{left:62, top:43}, T6:{left:62, top:46}, T7:{left:62, top:49},
    T8:{left:62, top:52}, T9:{left:62, top:55}, T10:{left:62, top:58}, T11:{left:62, top:61}, T12:{left:62, top:64},
    L1:{left:62, top:67}, L2:{left:62, top:70}, L3:{left:62, top:73}, L4:{left:62, top:76}, L5:{left:62, top:79},
    S1:{left:62, top:84}, S2:{left:62, top:87}, S3:{left:62, top:90}, S4:{left:62, top:93}, S5:{left:62, top:96}
  };

  /* ========== PERCORSI CLINICI (dolore -> dermatomo + coordinate dolore + coordinate muscolo) ========== */
  const PATHWAYS = {
    mano: {
      pollice: {
        dermatome: "C6",
        bodyImg: "upper",
        pain:   {left:76, top:90},
        muscle: {left:22, top:26}, // area avambraccio radiale (estensori/abduttori pollice)
        muscleName: "Abduttori/estensori del pollice (comparto radiale)",
        scientific: `
          <p><b>Target 1 (C6):</b> modulazione afferenze segmentarie legate alla sensibilità radiale mano/pollice.</p>
          <p><b>Target 2 (dolore):</b> riduzione del “rumore” nocicettivo locale e normalizzazione del tono di protezione.</p>
          <p><b>Target 3 (muscolo):</b> ottimizzazione controllo fine e reclutamento (presa/pinza), riducendo co-contrazioni inutili.</p>
        `,
        patient: `
          <p>Metti un bollino sul livello <b>C6</b> (collo/bassa cervicale) perché è il “cavo” che porta sensibilità al pollice.
          Poi un bollino sul punto dove fa male e uno sul muscolo dell’avambraccio che muove il pollice: così il movimento diventa più fluido e meno “in difesa”.</p>
        `
      },
      indice: {
        dermatome: "C6",
        bodyImg: "upper",
        pain:   {left:73, top:86},
        muscle: {left:26, top:28},
        muscleName: "Estensori dita (comparto posteriore avambraccio)",
        scientific: `
          <p><b>Target 1 (C6):</b> focus segmentario per distretto radiale della mano.</p>
          <p><b>Target 2 (dolore):</b> miglioramento percezione e riduzione iper-protezione.</p>
          <p><b>Target 3 (muscolo):</b> coordinazione dell’estensione/funzione di presa.</p>
        `,
        patient: `<p>Un bollino sul livello <b>C6</b>, uno sul dolore dell’indice e uno sul muscolo che controlla il dito: aiuta a muovere meglio senza irrigidirti.</p>`
      },
      medio: {
        dermatome: "C7",                // ✅ come hai chiesto: dito medio -> C7
        bodyImg: "upper",
        pain:   {left:70, top:82},
        muscle: {left:32, top:30},      // estensore comune dita (zona dorsale avambraccio)
        muscleName: "Estensore comune delle dita (Extensor digitorum)",
        scientific: `
          <p><b>Target 1 (C7):</b> modulazione segmentaria del distretto centrale della mano (dito medio) con integrazione sensitivo-motoria.</p>
          <p><b>Target 2 (dolore):</b> riduzione del segnale doloroso locale e miglioramento della qualità propriocettiva.</p>
          <p><b>Target 3 (muscolo):</b> ottimizzazione del reclutamento dell’<b>estensore comune delle dita</b> per ridurre co-contrazioni e sovraccarichi.</p>
        `,
        patient: `
          <p>Per il dito medio il livello guida è <b>C7</b>: è come il “punto centralina” del nervo.
          Poi metti un bollino dove senti dolore e uno sul muscolo dell’avambraccio che muove il dito: così il dito lavora con meno tensione.</p>
        `
      },
      anulare: {
        dermatome: "C7",
        bodyImg: "upper",
        pain:   {left:67, top:86},
        muscle: {left:34, top:32},
        muscleName: "Estensori dita / flessori dita (sinergia)",
        scientific: `
          <p><b>Target 1 (C7):</b> (variabile C7–C8) usiamo C7 come riferimento iniziale.</p>
          <p><b>Target 2 (dolore):</b> modulazione locale e normalizzazione schema motorio.</p>
          <p><b>Target 3 (muscolo):</b> sinergia flessori/estensori per migliorare controllo.</p>
        `,
        patient:`<p>Metti un bollino su <b>C7</b>, uno sull’anulare dove fa male e uno sul muscolo dell’avambraccio che aiuta il movimento.</p>`
      },
      mignolo: {
        dermatome: "C8",
        bodyImg: "upper",
        pain:   {left:64, top:88},
        muscle: {left:38, top:36}, // comparto ulnare avambraccio
        muscleName: "Muscoli ulnari mano/avambraccio (controllo mignolo)",
        scientific: `
          <p><b>Target 1 (C8):</b> focus segmentario distretto ulnare (mignolo).</p>
          <p><b>Target 2 (dolore):</b> riduzione iperattività protettiva locale.</p>
          <p><b>Target 3 (muscolo):</b> miglioramento controllo fine e presa ulnare.</p>
        `,
        patient:`<p>Per il mignolo la guida è <b>C8</b>: un bollino lì, uno sul dolore e uno sul muscolo che controlla il lato del mignolo.</p>`
      }
    },

    ginocchio: {
      mediale: {
        dermatome: "L4",
        bodyImg: "lower",
        pain:   {left:44, top:44},
        muscle: {left:48, top:38},  // vasto mediale circa
        muscleName: "Vasto mediale (quadricipite)",
        scientific: `
          <p><b>Target 1 (L4):</b> modulazione segmentaria correlata a distretto antero-mediale del ginocchio.</p>
          <p><b>Target 2 (dolore):</b> riduzione del drive nocicettivo e miglioramento del controllo del carico.</p>
          <p><b>Target 3 (muscolo):</b> facilitazione del <b>vasto mediale</b> per stabilità femoro-rotulea e controllo in appoggio.</p>
        `,
        patient:`<p>Per il ginocchio interno partiamo da <b>L4</b> sulla colonna, poi un bollino dove fa male e uno sul muscolo che stabilizza il ginocchio.</p>`
      },
      laterale: {
        dermatome: "L5",
        bodyImg: "lower",
        pain:   {left:56, top:44},
        muscle: {left:54, top:36},  // tensore fascia lata/ banda ileotibiale area
        muscleName: "Tensore fascia lata / complesso laterale coscia",
        scientific: `
          <p><b>Target 1 (L5):</b> riferimento segmentario per distretto laterale.</p>
          <p><b>Target 2 (dolore):</b> modulazione del segnale e riduzione compensi.</p>
          <p><b>Target 3 (muscolo):</b> ottimizzazione controllo laterale (stabilità in carico).</p>
        `,
        patient:`<p>Per il ginocchio esterno: un bollino su <b>L5</b>, uno sul dolore e uno sul muscolo laterale che controlla la stabilità.</p>`
      },
      anteriore: {
        dermatome: "L3",
        bodyImg: "lower",
        pain:   {left:50, top:40},
        muscle: {left:50, top:34}, // retto femorale circa
        muscleName: "Quadricipite (retto femorale/VMO)",
        scientific: `
          <p><b>Target 1 (L3):</b> riferimento per distretto anteriore.</p>
          <p><b>Target 2 (dolore):</b> riduzione iper-protezione del comparto anteriore.</p>
          <p><b>Target 3 (muscolo):</b> miglior controllo del quadricipite in flesso-estensione.</p>
        `,
        patient:`<p>Per il dolore davanti al ginocchio: bollino su <b>L3</b>, poi sul dolore e sul muscolo della coscia che fa estendere il ginocchio.</p>`
      },
      posteriore: {
        dermatome: "S1",
        bodyImg: "lower",
        pain:   {left:50, top:48},
        muscle: {left:50, top:52}, // polpaccio (soleo/gastrocnemio)
        muscleName: "Gastrocnemio/Soleo (catena posteriore)",
        scientific: `
          <p><b>Target 1 (S1):</b> riferimento per catena posteriore e distretto posteriore ginocchio.</p>
          <p><b>Target 2 (dolore):</b> modulazione del dolore in cavo popliteo.</p>
          <p><b>Target 3 (muscolo):</b> normalizzazione tono catena posteriore (polpaccio) legata al ginocchio.</p>
        `,
        patient:`<p>Per il dolore dietro al ginocchio: bollino su <b>S1</b>, poi sul punto dolente e sul polpaccio.</p>`
      }
    }
  };

  /* ========== STATO + HELPERS ========== */
  const STATE = { step:1, area:"", side:"", zone:"", zoneLabel:"", intensity:"", duration:"", notes:"" };
  const $ = (id)=>document.getElementById(id);

  function showStep(n){
    STATE.step=n;
    ["step1","step2","step3","step4"].forEach((s,i)=>$(s).classList.toggle("active", i===n-1));
    const barSteps = 4;
    const idx = Math.min(n, barSteps);
    $("bar").style.width = (((idx-1)/(barSteps-1))*100) + "%";
  }

  function openModal(meta){
    $("modalTitle").textContent = meta.title || "Dettaglio";
    const c = $("modalChips"); c.innerHTML="";
    (meta.chips||[]).forEach(x=>{ const s=document.createElement("span"); s.className="chip"; s.textContent=x; c.appendChild(s); });

    $("modalVertebra").innerHTML = `Livello / punto: <b>${meta.level || "—"}</b>`;
    $("modalProfBody").innerHTML = meta.scientific || "<p>—</p>";
    $("modalPatientBody").innerHTML = meta.patient || "<p>—</p>";
    $("modalBack").style.display="flex";
  }
  function closeModal(){ $("modalBack").style.display="none"; }
  $("modalClose").addEventListener("click", closeModal);
  $("modalBack").addEventListener("click", (e)=>{ if(e.target===$("modalBack")) closeModal(); });

  function renderZones(){
    const box = $("zones");
    box.innerHTML="";
    (ZONES[STATE.area]||[]).forEach(([val,label,hint])=>{
      const b=document.createElement("button");
      b.type="button";
      b.className="zoneBtn";
      b.dataset.zone=val;
      b.innerHTML=`<b>${label}</b><small>${hint}</small>`;
      b.addEventListener("click", ()=>{
        STATE.zone=val; STATE.zoneLabel=label;
        [...box.querySelectorAll(".zoneBtn")].forEach(x=>x.classList.toggle("selected", x.dataset.zone===val));
      });
      box.appendChild(b);
    });
  }

  function clearMarkers(){
    ["wrapSpine","wrapBody"].forEach(w=>{
      const wrap=$(w);
      [...wrap.querySelectorAll(".marker")].forEach(m=>m.remove());
    });
  }

  function addMarker(wrapId, left, top, meta){
    const wrap = $(wrapId);
    const m = document.createElement("div");
    m.className = "marker show";
    m.style.left = left + "%";
    m.style.top  = top  + "%";
    m.innerHTML = `<div class="dot" title="Tocca per dettagli"></div>`;
    m.addEventListener("click",(ev)=>{ ev.stopPropagation(); openModal(meta); });
    wrap.appendChild(m);
  }

  function setImages(){
    // Colonna segmenti
    $("spineFallback").style.display="none";
    $("imgSpine").onerror = ()=>{ $("spineFallback").style.display="block"; };
    $("imgSpine").src = IMG.spineSegments;

    // Distretto (arti sup/inf)
    const pathway = PATHWAYS[STATE.area]?.[STATE.zone];
    const bodyImgKey = pathway?.bodyImg || "upper";
    $("imgBody").src = IMG[bodyImgKey];
  }

  function buildSummaryText(pathway){
    return [
      `Area: ${STATE.area}`,
      `Lato: ${STATE.side}`,
      `Zona: ${STATE.zoneLabel}`,
      `Intensità: ${STATE.intensity}`,
      `Durata: ${STATE.duration}`,
      STATE.notes?.trim()?`Note: ${STATE.notes.trim()}`:"Note: —",
      ``,
      `Marker 1 (colonna): dermatomero ${pathway.dermatome}`,
      `Marker 2 (dolore): ${STATE.zoneLabel}`,
      `Marker 3 (muscolo): ${pathway.muscleName}`
    ].join("\n");
  }

  function setSafety(){
    const n = Number(STATE.intensity);
    const warn=[];
    if(!isNaN(n) && n>=8) warn.push("Dolore molto intenso (8–10): valuta un consulto medico.");
    const box=$("safety");
    if(warn.length){ box.style.display="block"; box.innerHTML = `<b>Attenzione:</b><ul>${warn.map(w=>`<li>${w}</li>`).join("")}</ul>`; }
    else { box.style.display="none"; box.innerHTML=""; }
  }

  /* ========== UI BUTTONS ========== */
  $("next1").addEventListener("click", ()=>{
    const a=$("area").value, s=$("side").value;
    if(!a||!s){ alert("Seleziona area e lato."); return; }
    STATE.area=a; STATE.side=s; STATE.zone=""; STATE.zoneLabel="";
    renderZones();
    showStep(2);
  });

  $("back2").addEventListener("click", ()=>showStep(1));
  $("next2").addEventListener("click", ()=>{
    if(!STATE.zone){ alert("Seleziona una zona."); return; }
    showStep(3);
  });

  $("back3").addEventListener("click", ()=>showStep(2));

  $("next3").addEventListener("click", ()=>{
    const intensity=$("intensity").value;
    const duration=$("duration").value;
    const notes=$("notes").value||"";
    const n=Number(intensity);
    if(intensity===""||isNaN(n)||n<0||n>10){ alert("Inserisci intensità 0–10."); return; }
    if(!duration){ alert("Seleziona la durata."); return; }

    STATE.intensity=intensity;
    STATE.duration=duration;
    STATE.notes=notes;

    const pathway = PATHWAYS[STATE.area]?.[STATE.zone];
    if(!pathway){
      alert("Percorso non definito per questa scelta. (Va aggiunto in PATHWAYS).");
      return;
    }

    setImages();
    clearMarkers();

    // 1) Marker colonna (dermatomero)
    const lev = pathway.dermatome;
    const pos = SPINE_LEVEL[lev];
    if(pos){
      addMarker("wrapSpine", pos.left, pos.top, {
        title: `Segmento ${lev} (dermatomero)`,
        level: lev,
        chips: ["colonna","dermatomero", lev],
        scientific: `
          <p><b>Perché qui:</b> il dolore riferito nel distretto selezionato è coerente con afferenze del segmento <b>${lev}</b>.
          Un punto su colonna “ancora” il lavoro al livello segmentario e riduce il mismatch sensitivo-motorio.</p>
          <p><b>Cosa fa Equistasi (razionale):</b> stimolo propriocettivo che favorisce una riorganizzazione del controllo posturale e del tono,
          migliorando la qualità dell’informazione afferente e riducendo la reattività di protezione.</p>
        `,
        patient: `<p>Questo bollino è sulla colonna nel livello <b>${lev}</b>: è il “punto centralina” collegato alla zona che ti fa male.</p>`
      });
    }

    // 2) Marker dolore sul distretto
    addMarker("wrapBody", pathway.pain.left, pathway.pain.top, {
      title: "Punto dolore (distretto)",
      level: "Area dolore",
      chips: ["dolore","distretto"],
      scientific: `
        <p><b>Perché qui:</b> il marker localizza la sede sintomatica. Il lavoro “locale” integra la modulazione segmentaria e migliora la qualità del segnale sensoriale.</p>
        <p><b>Effetto atteso:</b> riduzione del “segnale in allarme”, normalizzazione del tono di protezione e miglioramento del movimento.</p>
      `,
      patient: `<p>Questo bollino indica <b>dove senti dolore</b>. Serve a guidarti e a verificare se il fastidio diminuisce nei giorni.</p>`
    });

    // 3) Marker muscolo chiave
    addMarker("wrapBody", pathway.muscle.left, pathway.muscle.top, {
      title: `Muscolo chiave: ${pathway.muscleName}`,
      level: "Punto muscolare",
      chips: ["muscolo","movimento"],
      scientific: `
        <p><b>Perché qui:</b> il dolore altera il reclutamento. Un punto sul muscolo/comparto coinvolto facilita una migliore sequenza di attivazione
        e riduce co-contrazioni disfunzionali.</p>
        <p><b>Effetto atteso:</b> gesto più economico, meno rigidità, migliore precisione (soprattutto nella mano) o stabilità (ginocchio).</p>
      `,
      patient: `<p>Questo bollino è sul <b>muscolo che muove e stabilizza</b> la zona: aiuta il corpo a usare il muscolo in modo più “pulito”, senza irrigidirsi.</p>`
    });

    $("summary").textContent = buildSummaryText(pathway);
    setSafety();
    showStep(4);
  });

  $("restart").addEventListener("click", ()=>{
    Object.assign(STATE,{step:1,area:"",side:"",zone:"",zoneLabel:"",intensity:"",duration:"",notes:""});
    $("area").value=""; $("side").value="";
    $("zones").innerHTML="";
    $("intensity").value=""; $("duration").value=""; $("notes").value="";
    $("summary").textContent="";
    $("safety").style.display="none"; $("safety").innerHTML="";
    clearMarkers();
    showStep(1);
  });

  $("copy").addEventListener("click", async ()=>{
    const t=$("summary").textContent||"";
    if(!t){ alert("Nulla da copiare."); return; }
    try{ await navigator.clipboard.writeText(t); alert("Testo copiato."); }
    catch(e){ alert("Copia non disponibile: seleziona e copia manualmente."); }
  });

  showStep(1);
</script>
</body>
</html>








